stage 'Clear workspace'

node {
    deleteDir()
    checkout scm
}

stage "Install dependency"

node {
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
        sh 'sudo ansible-galaxy install -R . -r requirements.yml'
    }
}

stage "Check dry-run"

node {
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
        ansiblePlaybook(
            playbook: 'starschema.yml',
            inventory: 'inventory.ini',
            credentialsId: '96b3fe82-e6a4-45eb-9e8d-0a512cba5a9c',
            extras: '--check --diff',
            colorized: true
            )
    }
}

stage "Deploy to production"

node {
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
        ansiblePlaybook(
            playbook: 'starschema.yml',
            inventory: 'inventory.ini',
            credentialsId: '96b3fe82-e6a4-45eb-9e8d-0a512cba5a9c',
            colorized: true
            )
    }
}